(function(a){function d(b,d){this.el=a(b);this.el.attr("autocomplete","off");this.suggestions=[];this.data=[];this.badQueries=[];this.selectedIndex=-1;this.currentValue=this.el.val();this.intervalId=0;this.cachedResponse=[];this.onChangeInterval=null;this.ignoreValueChange=false;this.serviceUrl=d.serviceUrl;this.isLocal=false;this.options={autoSubmit:false,minChars:1,maxHeight:300,deferRequestBy:0,width:0,highlight:true,params:{},fnFormatResult:c,delimiter:null,zIndex:9999};this.initialize();this.setOptions(d)}function c(a,c,d){var e="("+d.replace(b,"\\$1")+")";return a.replace(new RegExp(e,"gi"),"<strong>$1</strong>")}var b=new RegExp("(\\"+["/",".","*","+","?","|","(",")","[","]","{","}","\\"].join("|\\")+")","g");a.fn.autocomplete=function(b){return new d(this.get(0)||a("<input />"),b)};d.prototype={killerFn:null,initialize:function(){var b,c,d;b=this;c=Math.floor(Math.random()*1048576).toString(16);d="Autocomplete_"+c;this.killerFn=function(c){if(a(c.target).parents(".autocomplete").size()===0){b.killSuggestions();b.disableKillerFn()}};if(!this.options.width){this.options.width=this.el.width()}this.mainContainerId="AutocompleteContainter_"+c;a('<div id="'+this.mainContainerId+'" style="position:absolute;z-index:9999;"><div class="autocomplete-w1"><div class="autocomplete" id="'+d+'" style="display:none; width:300px;"></div></div></div>').appendTo("body");this.container=a("#"+d);this.fixPosition();if(window.opera){this.el.keypress(function(a){b.onKeyPress(a)})}else{this.el.keydown(function(a){b.onKeyPress(a)})}this.el.keyup(function(a){b.onKeyUp(a)});this.el.blur(function(){b.enableKillerFn()});this.el.focus(function(){b.fixPosition()})},setOptions:function(b){var c=this.options;a.extend(c,b);if(c.lookup){this.isLocal=true;if(a.isArray(c.lookup)){c.lookup={suggestions:c.lookup,data:[]}}}a("#"+this.mainContainerId).css({zIndex:c.zIndex});this.container.css({maxHeight:c.maxHeight+"px",width:c.width})},clearCache:function(){this.cachedResponse=[];this.badQueries=[]},disable:function(){this.disabled=true},enable:function(){this.disabled=false},fixPosition:function(){var b=this.el.offset();a("#"+this.mainContainerId).css({top:b.top+this.el.innerHeight()+"px",left:b.left+"px"})},enableKillerFn:function(){var b=this;a(document).bind("click",b.killerFn)},disableKillerFn:function(){var b=this;a(document).unbind("click",b.killerFn)},killSuggestions:function(){var a=this;this.stopKillSuggestions();this.intervalId=window.setInterval(function(){a.hide();a.stopKillSuggestions()},300)},stopKillSuggestions:function(){window.clearInterval(this.intervalId)},onKeyPress:function(a){if(this.disabled||!this.enabled){return}switch(a.keyCode){case 27:this.el.val(this.currentValue);this.hide();break;case 9:case 13:if(this.selectedIndex===-1){this.hide();return}this.select(this.selectedIndex);if(a.keyCode===9){return}break;case 38:this.moveUp();break;case 40:this.moveDown();break;default:return}a.stopImmediatePropagation();a.preventDefault()},onKeyUp:function(a){if(this.disabled){return}switch(a.keyCode){case 38:case 40:return}clearInterval(this.onChangeInterval);if(this.currentValue!==this.el.val()){if(this.options.deferRequestBy>0){var b=this;this.onChangeInterval=setInterval(function(){b.onValueChange()},this.options.deferRequestBy)}else{this.onValueChange()}}},onValueChange:function(){clearInterval(this.onChangeInterval);this.currentValue=this.el.val();var a=this.getQuery(this.currentValue);this.selectedIndex=-1;if(this.ignoreValueChange){this.ignoreValueChange=false;return}if(a===""||a.length<this.options.minChars){this.hide()}else{this.getSuggestions(a)}},getQuery:function(b){var c,d;c=this.options.delimiter;if(!c){return a.trim(b)}d=b.split(c);return a.trim(d[d.length-1])},getSuggestionsLocal:function(a){var b,c,d,e,f;c=this.options.lookup;d=c.suggestions.length;b={suggestions:[],data:[]};a=a.toLowerCase();for(f=0;f<d;f++){e=c.suggestions[f];if(e.toLowerCase().indexOf(a)===0){b.suggestions.push(e);b.data.push(c.data[f])}}return b},getSuggestions:function(b){var c,d;c=this.isLocal?this.getSuggestionsLocal(b):this.cachedResponse[b];if(c&&a.isArray(c.suggestions)){this.suggestions=c.suggestions;this.data=c.data;this.suggest()}else if(!this.isBadQuery(b)){d=this;d.options.params.query=b;a.getJSON(this.serviceUrl,d.options.params,function(a){d.processResponse(a)})}},isBadQuery:function(a){var b=this.badQueries.length;while(b--){if(a.indexOf(this.badQueries[b])===0){return true}}return false},hide:function(){this.enabled=false;this.selectedIndex=-1;this.container.hide()},suggest:function(){if(this.suggestions.length===0){this.hide();return}var b,c,d,e,f,g,h,i,j;b=this;c=this.suggestions.length;e=this.options.fnFormatResult;f=this.getQuery(this.currentValue);i=function(a){return function(){b.activate(a)}};j=function(a){return function(){b.select(a)}};this.container.hide().empty();for(g=0;g<c;g++){h=this.suggestions[g];d=a((b.selectedIndex===g?'<div class="selected"':"<div")+' title="'+h+'">'+e(h,this.data[g],f)+"</div>");d.mouseover(i(g));d.click(j(g));this.container.append(d)}this.enabled=true;this.container.show()},processResponse:function(a){if(!this.options.noCache){this.cachedResponse[a.query]=a;if(a.suggestions.length===0){this.badQueries.push(a.query)}}if(a.query===this.getQuery(this.currentValue)){this.suggestions=a.suggestions;this.data=a.data;this.suggest()}},activate:function(b){var c,d;c=this.container.children();if(this.selectedIndex!==-1&&c.length>this.selectedIndex){a(c.get(this.selectedIndex)).removeClass()}this.selectedIndex=b;if(this.selectedIndex!==-1&&c.length>this.selectedIndex){d=c.get(this.selectedIndex);a(d).addClass("selected")}return d},deactivate:function(a,b){a.className="";if(this.selectedIndex===b){this.selectedIndex=-1}},select:function(a){var b,c;b=this.suggestions[a];if(b){this.el.val(b);if(this.options.autoSubmit){c=this.el.parents("form");if(c.length>0){c.get(0).submit()}}this.ignoreValueChange=true;this.hide();this.onSelect(a)}},moveUp:function(){if(this.selectedIndex===-1){return}if(this.selectedIndex===0){this.container.children().get(0).className="";this.selectedIndex=-1;this.el.val(this.currentValue);return}this.adjustScroll(this.selectedIndex-1)},moveDown:function(){if(this.selectedIndex===this.suggestions.length-1){return}this.adjustScroll(this.selectedIndex+1)},adjustScroll:function(a){var b,c,d,e;b=this.activate(a);c=b.offsetTop;d=this.container.scrollTop();e=d+this.options.maxHeight-25;if(c<d){this.container.scrollTop(c)}else if(c>e){this.container.scrollTop(c-this.options.maxHeight+25)}this.el.val(this.getValue(this.suggestions[a]))},onSelect:function(b){var c,d,e,f;c=this;d=c.options.onSelect;e=c.suggestions[b];f=c.data[b];c.el.val(c.getValue(e));if(a.isFunction(d)){d(e,f,c.el)}},getValue:function(a){var b,c,d,e;e=this;b=e.options.delimiter;if(!b){return a}c=e.currentValue;d=c.split(b);if(d.length===1){return a}return c.substr(0,c.length-d[d.length-1].length)+a}}})(jQuery)
